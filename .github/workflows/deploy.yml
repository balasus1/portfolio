name: Build and Deploy Portfolio

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Create production docker-compose.yml
        run: |
          cat > docker-compose.prod.yml <<EOF
          services:
            portfolio:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
              container_name: portfolio-app
              restart: unless-stopped
              ports:
                - "80:80"
                - "443:443"
              volumes:
                - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
                - ./logs:/var/log/nginx
                - ./certbot/conf:/etc/letsencrypt:ro
                - ./certbot/www:/var/www/certbot:ro
              networks:
                - portfolio-network
              healthcheck:
                test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/health"]
                interval: 30s
                timeout: 3s
                retries: 3
                start_period: 10s
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"
              environment:
                - NODE_ENV=production
          networks:
            portfolio-network:
              driver: bridge
          EOF
      - name: Deploy configuration files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "docker-compose.prod.yml,nginx.conf"
          target: "/home/ubuntu/portfolio"
          debug: true  # Enable debug output for troubleshooting
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd /home/ubuntu/portfolio
            
            # Rename to docker-compose.yml (docker-compose uses this name by default)
            mv docker-compose.prod.yml docker-compose.yml || true
            
            # Create necessary directories
            mkdir -p logs certbot/conf certbot/www
            
            # Check if SSL certificates exist, if not, provide instructions
            if [ ! -d "certbot/conf/portfolio.balashan.dev" ]; then
              echo "‚ö†Ô∏è  SSL certificates not found!"
              echo "üìù Please run the following on your VPS to get certificates:"
              echo "   sudo certbot certonly --standalone -d portfolio.balashan.dev --email bala.s0027@gmail.com --agree-tos --non-interactive"
              echo "   sudo cp -r /etc/letsencrypt/live/portfolio.balashan.dev ~/portfolio/certbot/conf/"
              echo "   sudo chown -R \$USER:\$USER ~/portfolio/certbot"
              echo ""
              echo "‚ö†Ô∏è  Starting container without SSL (HTTP only) for now..."
            fi
            
            # Log in to GitHub Container Registry
            # Note: If package is private, you may need a Personal Access Token (PAT) instead of GITHUB_TOKEN
            # GITHUB_TOKEN only works within GitHub Actions environment, not on external VPS
            # For public packages, login may not be required
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin || true
            
            # Pull latest image
            echo "üì¶ Pulling latest portfolio image from registry..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest || {
              echo "‚ö†Ô∏è Failed to pull image. Using existing image if available."
            }
            
            # Stop old containers
            echo "üõë Stopping old containers..."
            docker compose down || true
            
            # Start new container
            echo "üöÄ Starting new container..."
            docker compose up -d
            
            # Clean up old/unused images
            echo "üßπ Cleaning up old images..."
            docker image prune -af --filter "until=168h" || true
            
            # Wait for container to start
            echo "‚è≥ Waiting for container to be healthy..."
            sleep 10
            
            # Verify deployment
            echo ""
            echo "üìä Container status:"
            docker compose ps
            echo ""
            echo "üìù Recent logs:"
            docker compose logs --tail=30 portfolio
            echo ""
            echo "üîç Health check:"
            curl -f http://localhost/health && echo "‚úÖ Health check passed" || echo "‚ö†Ô∏è Health check failed (container might still be starting)"
            echo ""
            echo "üåç Application URLs:"
            echo "------------------------------------"
            echo "‚û°Ô∏è  Portfolio HTTPS URL: https://portfolio.balashan.dev"
            echo "‚û°Ô∏è  Portfolio HTTP URL (redirects to HTTPS): http://portfolio.balashan.dev"
            echo "‚û°Ô∏è  Fallback IP URL: http://${{ secrets.VPS_HOST }}"
            echo "------------------------------------"
            echo ""
            # Test HTTPS if certificates exist
            if [ -d "certbot/conf/portfolio.balashan.dev" ]; then
              echo "üîê Testing HTTPS connection..."
              curl -I https://portfolio.balashan.dev 2>&1 | head -5 || echo "‚ö†Ô∏è  HTTPS test failed (certificate might need renewal)"
            else
              echo "‚ö†Ô∏è  SSL certificates not configured. Site will work on HTTP only."
              echo "   Run: sudo certbot certonly --standalone -d portfolio.balashan.dev"
            fi