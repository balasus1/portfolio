name: Build and Deploy Portfolio

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Create production docker-compose.yml
        run: |
          cat > docker-compose.prod.yml <<EOF
          services:
            portfolio:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
              container_name: portfolio-app
              restart: unless-stopped
              ports:
                - "80:80"
              volumes:
                - ./logs:/var/log/nginx
              networks:
                - portfolio-network
              # Docker Compose healthcheck configuration (valid keyword)
              # Note: Healthcheck uses localhost because it runs inside the container
              healthcheck:
                test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
                interval: 30s
                timeout: 3s
                retries: 3
                start_period: 10s
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"
          networks:
            portfolio-network:
              driver: bridge
          EOF
      
      # Note: VPS_HOST, VPS_USER, and VPS_SSH_KEY are custom secrets that must be configured
      # in Repository Settings â†’ Secrets and variables â†’ Actions
      # IMPORTANT: VPS_HOST must be the IP address (e.g., 148.113.44.73), NOT the domain name
      # because Cloudflare only proxies HTTP/HTTPS traffic, not SSH (port 22)
      # Linter warnings about these secrets are expected and can be ignored
      #
      # SSH Key Troubleshooting:
      # - Ensure public key is in VPS ~/.ssh/authorized_keys
      # - Private key must include BEGIN/END header/footer lines
      # - Test SSH manually: ssh -i ~/.ssh/key ubuntu@148.113.44.73
      
      - name: Deploy configuration files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "docker-compose.prod.yml,nginx.conf"
          target: "/home/ubuntu/portfolio"
          debug: true  # Enable debug output for troubleshooting
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd /home/ubuntu/portfolio
            
            # Rename to docker-compose.yml (docker-compose uses this name by default)
            mv docker-compose.prod.yml docker-compose.yml || true
            
            # Log in to GitHub Container Registry
            # Note: If package is private, you may need a Personal Access Token (PAT) instead of GITHUB_TOKEN
            # GITHUB_TOKEN only works within GitHub Actions environment, not on external VPS
            # For public packages, login may not be required
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin || true
            
            # Pull latest image
            echo "ðŸ“¦ Pulling latest image from registry..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest || {
              echo "âš ï¸ Failed to pull image. Using existing image if available."
            }
            
            # Stop old container
            echo "ðŸ›‘ Stopping old container..."
            docker compose down || true
            
            # Start new container with latest image
            echo "ðŸš€ Starting new container..."
            docker compose up -d
            
            # Clean up old/unused images
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=168h" || true
            
            # Wait for container to start
            echo "â³ Waiting for container to be healthy..."
            sleep 10
            
            # Verify deployment
            echo ""
            echo "ðŸ“Š Container status:"
            docker compose ps
            echo ""
            echo "ðŸ“ Recent logs:"
            docker compose logs --tail=30 portfolio
            echo ""
            echo "ðŸ” Health check:"
            curl -f http://localhost/health && echo "âœ… Health check passed" || echo "âš ï¸ Health check failed"
                        echo ""
            echo "ðŸŒ Application URLs:"
            echo "------------------------------------"
            echo "âž¡ï¸  Portfolio URL: https://portfolio.balashan.dev"
            echo "âž¡ï¸  Fallback IP URL: http://${{ secrets.VPS_HOST }}"
            echo "------------------------------------"
